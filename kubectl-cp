#!/usr/bin/env python3
# pylint: disable=invalid-name
# -*- coding: utf-8 -*-
"""
---
name: kubectl-cp
description: An easy way to copy files from/to containers running on Kubernetes
website: https://github.com/marcio-pessoa/kubectl-cp
"""

import argparse
import os
import shlex
import subprocess


class KubectlCP():
    """ KubectlCP class """

    __version__ = '0.1.0'
    __date__ = '2023-09-15'

    def __init__(self):
        self.__verbose = False

        parser = argparse.ArgumentParser(
            prog='kubectl-cp',
            description=(
                'An easy way to copy files from/to containers running on '
                'Kubernetes'
            ),
            formatter_class=argparse.RawDescriptionHelpFormatter,
            add_help=True,
            epilog=(
                'examples:\n'
                '  kubectl-cp src dst\n'
                '  kubectl-cp src dst\n'
                '\n'
                'Copyleft (c) 2023-2023 Marcio Pessoa\n'
                'License: GPLv3\n'
                'Website: https://github.com/marcio-pessoa/kubectl-cp\n'
                'Contact: Marcio Pessoa <marcio.pessoa@gmail.com>\n'
            ),
        )
        parser.add_argument(
            '-V', '--version',
            action='version',
            help='show version information and exit',
            version=(
                f'kubectl-cp {self.__version__} {self.__date__}'
            ),
        )
        parser.add_argument(
            '-v', '--verbose',
            help='Enable verbose output',
            action='store_true'
        )

        parser.add_argument(
            'src_file',
            help='Source file')
        parser.add_argument(
            'dst_file',
            help='Destination file')
        parser.add_argument(
            '-a', '--arguments',
            help='kubectl arguments'
        )

        args = parser.parse_args()
        if args.verbose:
            self.__verbose = True

        self._verbose(f'source: {args.src_file}')
        self._verbose(f'destination: {args.dst_file}')
        self._verbose(f'arguments: {args.arguments}')

        self.from_container_to_localhost(
            args.src_file, args.dst_file, args.arguments)

    def _verbose(self, message):
        if self.__verbose:
            print(message)

    def from_container_to_localhost(self, src_file, dst_file, kubectl_args):
        """ Copy a file from crontainer to localhost """
        if dst_file == '.':
            dst_file = os.path.basename(src_file)

        cmd = (f'kubectl exec -i {kubectl_args} '
               f'-- cat {src_file}')
        result = subprocess.check_output(shlex.split(cmd), shell=False)
        save_file(dst_file, result)

        return result

    def from_localhost_to_container(self):
        """ Copy a file from localhost to container """
        return


def save_file(file_path: str, content: bytes) -> bool:
    """ Save content to file

    Args:
        file_path (str): _description_
        content (bytes): _description_

    Returns:
        bool: _description_
    """
    with open(file_path, 'wb') as f:
        f.write(content)


if __name__ == '__main__':
    KubectlCP()
